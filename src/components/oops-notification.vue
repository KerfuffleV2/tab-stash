<template>
<Notification inactive @dismiss="clearErrorLog">
    <div :class="$style.msg">Oops!  Something went wrong.  Tab Stash will try to
    recover automatically.</div>

    <details :class="$style.details" @click.stop="">
        <summary>Get Help With This Crash</summary>

        <p>Here are a few options that might help.  Crash details are shown
        below for easy reference&mdash;they will be cleared once you close this
        notification.</p>

        <p>
            <button @click.stop="showTroubleshooting">Show Troubleshooting Guide</button>
            <button @click.stop="searchGitHub">Search for Similar Issues</button>
            <button @click.stop="copyErrorLog">Copy Crash Details</button>
        </p>

        <p><output ref="err_log_el" :class="$style.err_details_list">
            <p :class="$style.environment">
                <div>Browser: {{aboutBrowser}} ({{aboutPlatform}})</div>
                <div>Extension: {{aboutExtension}}</div>
            </p>
            <p v-for="err of errorLog">
                <div :class="$style.err_summary">{{err.summary}}</div>
                <div :class="$style.err_details">{{err.details}}</div>
            </p>
        </output></p>
    </details>

    <details :class="$style.details" @click.stop="">
        <summary>Hide Crash Reports</summary>

        <p>If you're seeing too many crash reports, you can temporarily hide
        them:</p>

        <p>
            <button @click.stop="hideCrashReports(5*60*1000)">for 5 minutes</button>
            <button @click.stop="hideCrashReports(60*60*1000)">for 1 hour</button>
            <button @click.stop="hideCrashReports(24*60*60*1000)">for 1 day</button>
            <button @click.stop="hideCrashReports(7*24*60*60*1000)">for 1 week</button>
        </p>

        <p>Crash reports can be turned on again in settings.</p>
    </details>
</Notification>
</template>

<script lang="ts">
import browser from 'webextension-polyfill';
import {Ref, ref, inject} from 'vue';

const TROUBLESHOOTING_URL = "https://josh-berry.github.io/tab-stash/support.html";

const aboutBrowser = ref('<Unknown Browser>');
if (browser.runtime.getBrowserInfo) {
    void browser.runtime.getBrowserInfo().then(info => {
        aboutBrowser.value = `${info.vendor} ${info.name} ${info.version} ${info.buildID}`;
    });
}

const aboutPlatform = ref('<Unknown Platform>');
if (browser.runtime.getPlatformInfo) {
    void browser.runtime.getPlatformInfo().then(info => {
        aboutPlatform.value = `${info.os} ${info.arch}`;
    });
}

const aboutExtension = ref('<Unknown Extension>');
if (browser.management.getSelf) {
    void browser.management.getSelf().then(info => {
        aboutExtension.value = `${info.name} ${info.version} (${info.installType})`;
    });
}
</script>

<script setup lang="ts">
import {errorLog, clearErrorLog, logErrorsFrom} from '../util/oops';
import {Model} from '../model';
const Notification = require('./notification.vue').default;

const model = inject<Model>('$model')!;

const err_log_el: Ref<object | null> = ref(null);

const showTroubleshooting = () =>
    logErrorsFrom(() => browser.tabs.create({url: TROUBLESHOOTING_URL}));

const searchGitHub = () => {
    // Some heuristics to widen the search (and hopefully return better results)
    // by excluding things that look like unique identifiers.
    const terms = errorLog[0].summary
        .replace(/[0-9]+/g, '')
        .replace(/:\s+\S+$/, '')
        .replace(/\S+:\S+/g, '')
        .replace(/\S+\.\S+/g, '')
        .replace(/"[^"]*"/g, '')
        .replace(/`[^`]*`/g, '')
        .replace(/\S+@\S+/g, '');
    const url = `https://github.com/josh-berry/tab-stash/issues?q=is%3Aissue+${
        encodeURIComponent(terms)}`;
    void logErrorsFrom(() => browser.tabs.create({url}));
};

const copyErrorLog = async () => {
    const el = <HTMLElement>err_log_el.value;

    el.focus();
    window.getSelection()?.selectAllChildren(el);
    document.execCommand('copy');
};

const hideCrashReports = (ms: number) => logErrorsFrom(async () => {
    await model.options.local.set({hide_crash_reports_until: Date.now() + ms});
    clearErrorLog();
});
</script>

<style module>
.msg {
    margin-bottom: 1em;
}

.details > *:not(summary) {
    margin-left: var(--ctrl-mw);
}

.details > summary {
    border-radius: var(--ctrl-border-radius);
}

.details > summary:hover {
    background-color: var(--userlink-hover-fg);
}

.details > summary:active {
    background-color: var(--userlink-active-fg);
}

.err_details_list {
    user-select: text;
    -moz-user-select: text;
}

.error_log {
    user-select: text;
    -moz-user-select: text;
    cursor: text;
    margin: 0;
}

.environment { font-style: italic; }
.err_summary {
    font-weight: bold;
    white-space: pre-wrap;
}
.err_details {
    padding-left: var(--ctrl-pw);
    border-left: 2px solid var(--ctrl-border-clr);
    white-space: pre-wrap;
}
</style>
